#!/usr/bin/env python3
from __future__ import annotations

import argparse
import json
import subprocess
import sys
from pathlib import Path
from typing import Any


ROOT = Path(__file__).resolve().parents[1]


def _stable_dump(path: Path, payload: Any) -> None:
    path.parent.mkdir(parents=True, exist_ok=True)
    path.write_text(json.dumps(payload, indent=2, sort_keys=True) + "\n", encoding="utf-8")


def _render_report(
    payload: dict[str, Any],
    deltas: list[dict[str, Any]],
    *,
    plugin_set: str,
    seed: int,
) -> str:
    before = payload.get("dataset_before") or {}
    after = payload.get("dataset_after") or {}
    lines = [
        "# Dataset Run Comparison",
        "",
        "Generated by `scripts/compare_dataset_runs.py`.",
        "",
        f"- plugin_set: `{plugin_set}`",
        f"- seed: `{seed}`",
        f"- dataset_before: `{before.get('dataset_version_id', '')}`",
        f"- dataset_after: `{after.get('dataset_version_id', '')}`",
        "",
        "## Summary",
        "",
        f"- added_plugins: {len(payload.get('added_plugins') or [])}",
        f"- removed_plugins: {len(payload.get('removed_plugins') or [])}",
        f"- status_changes: {len(payload.get('status_changes') or [])}",
        f"- payload_changed: {payload.get('plugin_counts', {}).get('payload_changed', 0)}",
        "",
        "## Top Deltas",
        "",
        "| Rank | Plugin | Status Before | Status After | Changed Components |",
        "|---:|---|---|---|---:|",
    ]
    for idx, row in enumerate(deltas, start=1):
        lines.append(
            f"| {idx} | `{row['plugin_id']}` | {row['status_before']} | "
            f"{row['status_after']} | {row['changed_component_count']} |"
        )
    lines.append("")
    return "\n".join(lines)


def main() -> int:
    parser = argparse.ArgumentParser(description="Generate standardized dataset-vs-dataset comparison artifacts.")
    parser.add_argument("--dataset-before", required=True)
    parser.add_argument("--dataset-after", required=True)
    parser.add_argument("--dataset-statuses", default="completed")
    parser.add_argument("--plugin-set", default="full")
    parser.add_argument("--seed", type=int, default=123)
    parser.add_argument("--out-dir", default=str(ROOT / "docs" / "release_evidence"))
    args = parser.parse_args()

    out_dir = Path(args.out_dir)
    summary_path = out_dir / "comparison_summary.json"
    deltas_path = out_dir / "comparison_recommendation_deltas.json"
    report_path = out_dir / "comparison_report.md"

    cmd = [
        sys.executable,
        str(ROOT / "scripts" / "compare_run_outputs.py"),
        "--dataset-before",
        str(args.dataset_before),
        "--dataset-after",
        str(args.dataset_after),
        "--dataset-statuses",
        str(args.dataset_statuses),
        "--output-json",
        str(summary_path),
    ]
    subprocess.run(cmd, check=True)

    payload = json.loads(summary_path.read_text(encoding="utf-8"))
    changed = list(payload.get("changed_plugins") or [])
    deltas = [
        {
            "plugin_id": str(row.get("plugin_id") or ""),
            "status_before": str(row.get("status_before") or ""),
            "status_after": str(row.get("status_after") or ""),
            "changed_component_count": int(len(row.get("changed_components") or [])),
            "changed_components": list(row.get("changed_components") or []),
        }
        for row in changed
    ]
    deltas.sort(
        key=lambda row: (
            0 if row["status_before"] != row["status_after"] else 1,
            -row["changed_component_count"],
            row["plugin_id"],
        )
    )
    _stable_dump(deltas_path, {"items": deltas})
    report_path.write_text(
        _render_report(
            payload,
            deltas[:50],
            plugin_set=str(args.plugin_set),
            seed=int(args.seed),
        ),
        encoding="utf-8",
    )
    print(str(summary_path))
    print(str(deltas_path))
    print(str(report_path))
    return 0


if __name__ == "__main__":
    raise SystemExit(main())

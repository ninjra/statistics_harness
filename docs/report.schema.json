{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Statistic Harness Report",
  "type": "object",
  "required": ["run_id", "created_at", "status", "input", "plugins", "lineage"],
  "definitions": {
    "recommendation_item": {
      "type": "object",
      "required": [
        "status",
        "recommendation",
        "plugin_id",
        "kind",
        "scope_class",
        "modeled_percent",
        "modeled_basis_hours",
        "modeled_delta_hours",
        "not_modeled_reason"
      ],
      "properties": {
        "status": {"type": "string"},
        "title": {"type": "string"},
        "category": {"type": "string"},
        "recommendation": {"type": "string"},
        "plugin_id": {"anyOf": [{"type": "string"}, {"type": "null"}]},
        "kind": {"anyOf": [{"type": "string"}, {"type": "null"}]},
        "scope_class": {
          "type": "string",
          "enum": ["general", "close_specific"]
        },
        "modeled_percent": {"anyOf": [{"type": "null"}, {"type": "number", "minimum": 0.0, "maximum": 100.0}]},
        "modeled_basis_hours": {"anyOf": [{"type": "null"}, {"type": "number", "minimum": 0.0}]},
        "modeled_delta_hours": {"anyOf": [{"type": "null"}, {"type": "number", "minimum": 0.0}]},
        "modeled_general_percent": {"anyOf": [{"type": "null"}, {"type": "number", "minimum": 0.0, "maximum": 100.0}]},
        "modeled_close_percent": {"anyOf": [{"type": "null"}, {"type": "number", "minimum": 0.0, "maximum": 100.0}]},
        "not_modeled_reason": {"anyOf": [{"type": "null"}, {"type": "string"}]}
      },
      "allOf": [
        {
          "if": {
            "required": ["modeled_percent"],
            "properties": {"modeled_percent": {"type": "null"}}
          },
          "then": {
            "required": ["not_modeled_reason"],
            "properties": {"not_modeled_reason": {"type": "string", "minLength": 1}}
          }
        },
        {
          "if": {
            "required": ["modeled_percent"],
            "properties": {"modeled_percent": {"type": "number"}}
          },
          "then": {
            "properties": {"not_modeled_reason": {"type": "null"}}
          }
        }
      ],
      "additionalProperties": true
    },
    "non_actionable_explanation_item": {
      "type": "object",
      "required": [
        "status",
        "plugin_id",
        "reason_code",
        "plain_english_explanation"
      ],
      "properties": {
        "status": {"type": "string"},
        "plugin_id": {"type": "string"},
        "plugin_type": {"type": "string"},
        "plugin_status": {"type": "string"},
        "kind": {"type": "string"},
        "reason_code": {"type": "string"},
        "plain_english_explanation": {"type": "string", "minLength": 1},
        "recommended_next_step": {"type": "string"},
        "downstream_plugins": {
          "type": "array",
          "items": {"type": "string"}
        },
        "downstream_plugin_count": {"type": "integer", "minimum": 0}
      },
      "additionalProperties": true
    }
  },
  "properties": {
    "run_id": {"type": "string"},
    "created_at": {"type": "string"},
    "status": {"type": "string"},
    "lineage": {
      "type": "object",
      "required": ["run", "input", "dataset", "plugins"],
      "properties": {
        "run": {
          "type": "object",
          "required": ["run_id", "created_at", "status", "run_seed"],
          "properties": {
            "run_id": {"type": "string"},
            "created_at": {"type": "string"},
            "status": {"type": "string"},
            "run_seed": {"type": "integer"}
          }
        },
        "input": {
          "type": "object",
          "properties": {
            "upload_id": {"type": "string"},
            "filename": {"type": "string"},
            "canonical_path": {"type": "string"},
            "input_hash": {"type": "string"},
            "sha256": {"type": "string"},
            "size_bytes": {"type": "integer"}
          }
        },
        "dataset": {
          "type": "object",
          "required": ["dataset_version_id"],
          "properties": {
            "project_id": {"type": "string"},
            "dataset_id": {"type": "string"},
            "dataset_version_id": {"type": "string"},
            "table_name": {"type": "string"},
            "data_hash": {"type": "string"},
            "row_count": {"type": "integer"},
            "column_count": {"type": "integer"},
            "raw_format_id": {"type": "integer"}
          }
        },
        "raw_format": {
          "anyOf": [
            {"type": "null"},
            {
              "type": "object",
              "properties": {
                "format_id": {"type": "integer"},
                "fingerprint": {"type": "string"},
                "name": {"type": "string"},
                "created_at": {"type": "string"}
              }
            }
          ]
        },
        "template": {
          "anyOf": [
            {"type": "null"},
            {
              "type": "object",
              "properties": {
                "template_id": {"type": "integer"},
                "template_name": {"type": "string"},
                "template_version": {"type": "string"},
                "table_name": {"type": "string"},
                "status": {"type": "string"},
                "mapping_hash": {"type": "string"},
                "mapping": {"type": "object"}
              }
            }
          ]
        },
        "plugins": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "plugin_version": {"type": "string"},
              "code_hash": {"type": "string"},
              "settings_hash": {"type": "string"},
              "dataset_hash": {"type": "string"},
              "executed_at": {"type": "string"},
              "status": {"type": "string"},
              "summary": {"type": "string"}
            }
          }
        }
      }
    },
    "input": {
      "type": "object",
      "required": ["filename", "rows", "cols", "inferred_types"],
      "properties": {
        "filename": {"type": "string"},
        "rows": {"type": "integer"},
        "cols": {"type": "integer"},
        "inferred_types": {"type": "object"}
      }
    },
    "plugins": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "required": ["status", "summary", "metrics", "findings", "artifacts", "budget", "error", "references", "debug"],
        "properties": {
          "status": {"type": "string"},
          "summary": {"type": "string"},
          "metrics": {"type": "object"},
          "references": {"type": "array"},
          "debug": {"type": "object"},
          "budget": {
            "type": "object",
            "required": ["row_limit", "sampled", "time_limit_ms", "cpu_limit_ms"],
            "properties": {
              "row_limit": {"anyOf": [{"type": "integer"}, {"type": "null"}]},
              "sampled": {"type": "boolean"},
              "time_limit_ms": {"anyOf": [{"type": "integer"}, {"type": "null"}]},
              "cpu_limit_ms": {"anyOf": [{"type": "integer"}, {"type": "null"}]},
              "notes": {"anyOf": [{"type": "string"}, {"type": "null"}]}
            },
            "additionalProperties": true
          },
          "findings": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["evidence", "measurement_type"],
              "properties": {
                "evidence": {
                  "type": "object",
                  "required": [
                    "dataset_id",
                    "dataset_version_id",
                    "row_ids",
                    "column_ids",
                    "query"
                  ],
                  "properties": {
                    "dataset_id": {"type": "string"},
                    "dataset_version_id": {"type": "string"},
                    "row_ids": {"type": "array", "items": {"type": "integer"}},
                    "column_ids": {"type": "array", "items": {"type": "integer"}},
                    "query": {"anyOf": [{"type": "string"}, {"type": "null"}]}
                  },
                  "additionalProperties": true
                }
                ,
                "measurement_type": {
                  "type": "string",
                  "enum": ["measured", "modeled", "not_applicable", "error"]
                }
              },
              "additionalProperties": true
            }
          },
          "artifacts": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["path", "type", "description"],
              "properties": {
                "path": {"type": "string"},
                "type": {"type": "string"},
                "description": {"type": "string"}
              }
            }
          },
          "error": {
            "anyOf": [
              {"type": "null"},
              {
                "type": "object",
                "required": ["type", "message", "traceback"],
                "properties": {
                  "type": {"type": "string"},
                  "message": {"type": "string"},
                  "traceback": {"type": "string"}
                }
              }
            ]
          }
        }
      }
    },
    "hotspots": {
      "type": "object",
      "properties": {
        "generated_at": {"type": "string"},
        "notes": {"type": "string"},
        "top_by_duration_ms": {"type": "array"},
        "top_by_max_rss_kb": {"type": "array"},
        "failures": {"type": "array"},
        "totals": {"type": "object"}
      },
      "additionalProperties": true
    },
    "known_issues": {
      "type": "object",
      "properties": {
        "scope_type": {"type": "string"},
        "scope_value": {"type": "string"},
        "strict": {"type": "boolean"},
        "notes": {"type": "string"},
        "natural_language": {"type": "array"},
        "expected_findings": {"type": "array"}
      },
      "additionalProperties": true
    },
    "evaluation": {
      "type": "object",
      "properties": {
        "evaluated_at": {"type": "string"},
        "result": {"type": "string"},
        "ok": {"type": "boolean"},
        "messages": {"type": "array"}
      },
      "additionalProperties": true
    },
    "recommendations": {
      "type": "object",
      "required": ["status", "summary", "known", "discovery", "items", "explanations"],
      "properties": {
        "status": {"type": "string"},
        "summary": {"type": "string"},
        "known": {
          "type": "object",
          "required": ["status", "summary", "items"],
          "properties": {
            "status": {"type": "string"},
            "summary": {"type": "string"},
            "items": {
              "type": "array",
              "items": {"$ref": "#/definitions/recommendation_item"}
            }
          },
          "additionalProperties": true
        },
        "discovery": {
          "type": "object",
          "required": ["status", "summary", "items"],
          "properties": {
            "status": {"type": "string"},
            "summary": {"type": "string"},
            "items": {
              "type": "array",
              "items": {"$ref": "#/definitions/recommendation_item"}
            }
          },
          "additionalProperties": true
        },
        "items": {
          "type": "array",
          "items": {"$ref": "#/definitions/recommendation_item"}
        },
        "explanations": {
          "type": "object",
          "required": ["status", "summary", "items"],
          "properties": {
            "status": {"type": "string"},
            "summary": {"type": "string"},
            "items": {
              "type": "array",
              "items": {"$ref": "#/definitions/non_actionable_explanation_item"}
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    }
  }
}
